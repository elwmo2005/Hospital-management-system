-- ===================================================================
-- HOSPITAL MANAGEMENT SYSTEM - ORACLE DATABASE SCHEMA
-- ===================================================================
-- Created from ERD diagram analysis
-- Supports multi-hospital, AI/ML integration, and comprehensive healthcare workflows
-- ===================================================================

-- ===================================================================
-- 1. CORE HOSPITAL ENTITY
-- ===================================================================

CREATE TABLE HOSPITALS (
    HOSPITAL_ID         NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                        MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                        INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    HOSPITAL_NAME       VARCHAR2(200) NOT NULL,
    ADDRESS             VARCHAR2(500),
    CITY                VARCHAR2(100),
    STATE               VARCHAR2(100),
    ZIP_CODE            VARCHAR2(20),
    COUNTRY             VARCHAR2(100),
    PHONE               VARCHAR2(50),
    EMAIL               VARCHAR2(100),
    LICENSE_NUMBER      VARCHAR2(100),
    ESTABLISHMENT_DATE  DATE,
    STATUS              VARCHAR2(20) DEFAULT 'ACTIVE' NOT NULL,
    HOSPITAL_TYPE       VARCHAR2(50),
    BED_CAPACITY        NUMBER(5,0),
    CREATED_DATE        TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_BY          VARCHAR2(100) DEFAULT USER NOT NULL,
    UPDATED_DATE        TIMESTAMP WITH TIME ZONE,
    UPDATED_BY          VARCHAR2(100),
    
    CONSTRAINT PK_HOSPITALS PRIMARY KEY (HOSPITAL_ID),
    CONSTRAINT UK_HOSPITALS_LICENSE UNIQUE (LICENSE_NUMBER),
    CONSTRAINT CK_HOSPITALS_STATUS CHECK (STATUS IN ('ACTIVE', 'INACTIVE', 'SUSPENDED'))
);

CREATE INDEX IDX_HOSPITALS_STATUS ON HOSPITALS(STATUS);
CREATE INDEX IDX_HOSPITALS_TYPE ON HOSPITALS(HOSPITAL_TYPE);

-- ===================================================================
-- 2. PATIENT MANAGEMENT TABLES
-- ===================================================================

CREATE TABLE PATIENTS (
    PATIENT_ID              NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                            MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                            INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    HOSPITAL_ID             NUMBER NOT NULL,
    PATIENT_NUMBER          VARCHAR2(50) NOT NULL,
    FIRST_NAME              VARCHAR2(100) NOT NULL,
    MIDDLE_NAME             VARCHAR2(100),
    LAST_NAME               VARCHAR2(100) NOT NULL,
    DATE_OF_BIRTH           DATE NOT NULL,
    GENDER                  CHAR(1) NOT NULL,
    PHONE                   VARCHAR2(50),
    EMAIL                   VARCHAR2(100),
    ADDRESS                 VARCHAR2(500),
    CITY                    VARCHAR2(100),
    STATE                   VARCHAR2(100),
    ZIP_CODE                VARCHAR2(20),
    COUNTRY                 VARCHAR2(100),
    BLOOD_TYPE              VARCHAR2(10),
    MARITAL_STATUS          VARCHAR2(20),
    OCCUPATION              VARCHAR2(100),
    EMERGENCY_CONTACT_NAME  VARCHAR2(200),
    EMERGENCY_CONTACT_PHONE VARCHAR2(50),
    NATIONAL_ID             VARCHAR2(50),
    MEDICAL_RECORD_NUMBER   VARCHAR2(50) NOT NULL,
    REGISTRATION_DATE       TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    STATUS                  VARCHAR2(20) DEFAULT 'ACTIVE' NOT NULL,
    CREATED_DATE            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_BY              VARCHAR2(100) DEFAULT USER NOT NULL,
    UPDATED_DATE            TIMESTAMP WITH TIME ZONE,
    UPDATED_BY              VARCHAR2(100),
    
    CONSTRAINT PK_PATIENTS PRIMARY KEY (PATIENT_ID),
    CONSTRAINT FK_PATIENTS_HOSPITAL FOREIGN KEY (HOSPITAL_ID) REFERENCES HOSPITALS(HOSPITAL_ID),
    CONSTRAINT UK_PATIENTS_NUMBER UNIQUE (HOSPITAL_ID, PATIENT_NUMBER),
    CONSTRAINT UK_PATIENTS_MRN UNIQUE (HOSPITAL_ID, MEDICAL_RECORD_NUMBER),
    CONSTRAINT CK_PATIENTS_GENDER CHECK (GENDER IN ('M', 'F', 'O')),
    CONSTRAINT CK_PATIENTS_STATUS CHECK (STATUS IN ('ACTIVE', 'INACTIVE', 'DECEASED'))
);

CREATE INDEX IDX_PATIENTS_HOSPITAL ON PATIENTS(HOSPITAL_ID);
CREATE INDEX IDX_PATIENTS_NAME ON PATIENTS(LAST_NAME, FIRST_NAME);
CREATE INDEX IDX_PATIENTS_DOB ON PATIENTS(DATE_OF_BIRTH);
CREATE INDEX IDX_PATIENTS_STATUS ON PATIENTS(STATUS);

CREATE TABLE PATIENT_ALLERGIES (
    ALLERGY_ID              NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                            MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                            INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    PATIENT_ID              NUMBER NOT NULL,
    HOSPITAL_ID             NUMBER NOT NULL,
    ALLERGEN                VARCHAR2(200) NOT NULL,
    ALLERGY_TYPE            VARCHAR2(50),
    SEVERITY                VARCHAR2(20),
    REACTION_DESCRIPTION    VARCHAR2(1000),
    IDENTIFIED_DATE         DATE,
    IDENTIFIED_BY           VARCHAR2(100),
    STATUS                  VARCHAR2(20) DEFAULT 'ACTIVE' NOT NULL,
    CREATED_DATE            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_BY              VARCHAR2(100) DEFAULT USER NOT NULL,
    
    CONSTRAINT PK_PATIENT_ALLERGIES PRIMARY KEY (ALLERGY_ID),
    CONSTRAINT FK_ALLERGIES_PATIENT FOREIGN KEY (PATIENT_ID) REFERENCES PATIENTS(PATIENT_ID),
    CONSTRAINT FK_ALLERGIES_HOSPITAL FOREIGN KEY (HOSPITAL_ID) REFERENCES HOSPITALS(HOSPITAL_ID),
    CONSTRAINT CK_ALLERGIES_SEVERITY CHECK (SEVERITY IN ('MILD', 'MODERATE', 'SEVERE', 'LIFE_THREATENING'))
);

CREATE INDEX IDX_ALLERGIES_PATIENT ON PATIENT_ALLERGIES(PATIENT_ID);

CREATE TABLE PATIENT_INSURANCE (
    INSURANCE_ID            NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                            MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                            INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    PATIENT_ID              NUMBER NOT NULL,
    HOSPITAL_ID             NUMBER NOT NULL,
    INSURANCE_PROVIDER      VARCHAR2(200) NOT NULL,
    POLICY_NUMBER           VARCHAR2(100) NOT NULL,
    GROUP_NUMBER            VARCHAR2(100),
    EFFECTIVE_DATE          DATE NOT NULL,
    EXPIRY_DATE             DATE,
    COVERAGE_TYPE           VARCHAR2(50),
    COVERAGE_PERCENTAGE     NUMBER(5,2),
    DEDUCTIBLE_AMOUNT       NUMBER(10,2),
    STATUS                  VARCHAR2(20) DEFAULT 'ACTIVE' NOT NULL,
    CREATED_DATE            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_BY              VARCHAR2(100) DEFAULT USER NOT NULL,
    
    CONSTRAINT PK_PATIENT_INSURANCE PRIMARY KEY (INSURANCE_ID),
    CONSTRAINT FK_INSURANCE_PATIENT FOREIGN KEY (PATIENT_ID) REFERENCES PATIENTS(PATIENT_ID),
    CONSTRAINT FK_INSURANCE_HOSPITAL FOREIGN KEY (HOSPITAL_ID) REFERENCES HOSPITALS(HOSPITAL_ID),
    CONSTRAINT CK_INSURANCE_COVERAGE CHECK (COVERAGE_PERCENTAGE >= 0 AND COVERAGE_PERCENTAGE <= 100)
);

CREATE INDEX IDX_INSURANCE_PATIENT ON PATIENT_INSURANCE(PATIENT_ID);

-- ===================================================================
-- 3. STAFF MANAGEMENT TABLES
-- ===================================================================

CREATE TABLE DEPARTMENTS (
    DEPARTMENT_ID           NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                            MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                            INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    HOSPITAL_ID             NUMBER NOT NULL,
    DEPARTMENT_NAME         VARCHAR2(200) NOT NULL,
    DEPARTMENT_CODE         VARCHAR2(20) NOT NULL,
    DESCRIPTION             VARCHAR2(1000),
    HEAD_OF_DEPARTMENT      NUMBER,
    LOCATION                VARCHAR2(200),
    PHONE_EXTENSION         VARCHAR2(20),
    STATUS                  VARCHAR2(20) DEFAULT 'ACTIVE' NOT NULL,
    CREATED_DATE            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_BY              VARCHAR2(100) DEFAULT USER NOT NULL,
    
    CONSTRAINT PK_DEPARTMENTS PRIMARY KEY (DEPARTMENT_ID),
    CONSTRAINT FK_DEPARTMENTS_HOSPITAL FOREIGN KEY (HOSPITAL_ID) REFERENCES HOSPITALS(HOSPITAL_ID),
    CONSTRAINT UK_DEPARTMENTS_CODE UNIQUE (HOSPITAL_ID, DEPARTMENT_CODE)
);

CREATE INDEX IDX_DEPARTMENTS_HOSPITAL ON DEPARTMENTS(HOSPITAL_ID);

CREATE TABLE STAFF_MEMBERS (
    STAFF_ID                NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                            MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                            INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    HOSPITAL_ID             NUMBER NOT NULL,
    DEPARTMENT_ID           NUMBER NOT NULL,
    EMPLOYEE_NUMBER         VARCHAR2(50) NOT NULL,
    FIRST_NAME              VARCHAR2(100) NOT NULL,
    MIDDLE_NAME             VARCHAR2(100),
    LAST_NAME               VARCHAR2(100) NOT NULL,
    STAFF_TYPE              VARCHAR2(50) NOT NULL,
    SPECIALIZATION          VARCHAR2(200),
    QUALIFICATION           VARCHAR2(500),
    LICENSE_NUMBER          VARCHAR2(100),
    LICENSE_EXPIRY          DATE,
    PHONE                   VARCHAR2(50),
    EMAIL                   VARCHAR2(100),
    ADDRESS                 VARCHAR2(500),
    DATE_OF_BIRTH           DATE,
    HIRE_DATE               DATE NOT NULL,
    TERMINATION_DATE        DATE,
    EMPLOYMENT_STATUS       VARCHAR2(20) DEFAULT 'ACTIVE' NOT NULL,
    HOURLY_RATE             NUMBER(10,2),
    SHIFT_PREFERENCE        VARCHAR2(20),
    CREATED_DATE            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_BY              VARCHAR2(100) DEFAULT USER NOT NULL,
    UPDATED_DATE            TIMESTAMP WITH TIME ZONE,
    UPDATED_BY              VARCHAR2(100),
    
    CONSTRAINT PK_STAFF_MEMBERS PRIMARY KEY (STAFF_ID),
    CONSTRAINT FK_STAFF_HOSPITAL FOREIGN KEY (HOSPITAL_ID) REFERENCES HOSPITALS(HOSPITAL_ID),
    CONSTRAINT FK_STAFF_DEPARTMENT FOREIGN KEY (DEPARTMENT_ID) REFERENCES DEPARTMENTS(DEPARTMENT_ID),
    CONSTRAINT UK_STAFF_EMPLOYEE_NO UNIQUE (HOSPITAL_ID, EMPLOYEE_NUMBER),
    CONSTRAINT CK_STAFF_TYPE CHECK (STAFF_TYPE IN ('DOCTOR', 'NURSE', 'TECHNICIAN', 'ADMIN', 'SUPPORT')),
    CONSTRAINT CK_EMPLOYMENT_STATUS CHECK (EMPLOYMENT_STATUS IN ('ACTIVE', 'INACTIVE', 'TERMINATED', 'ON_LEAVE'))
);

CREATE INDEX IDX_STAFF_HOSPITAL ON STAFF_MEMBERS(HOSPITAL_ID);
CREATE INDEX IDX_STAFF_DEPARTMENT ON STAFF_MEMBERS(DEPARTMENT_ID);
CREATE INDEX IDX_STAFF_TYPE ON STAFF_MEMBERS(STAFF_TYPE);

-- Add self-referencing constraint for department head
ALTER TABLE DEPARTMENTS ADD CONSTRAINT FK_DEPARTMENTS_HEAD 
    FOREIGN KEY (HEAD_OF_DEPARTMENT) REFERENCES STAFF_MEMBERS(STAFF_ID);

CREATE TABLE STAFF_SCHEDULES (
    SCHEDULE_ID             NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                            MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                            INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    STAFF_ID                NUMBER NOT NULL,
    HOSPITAL_ID             NUMBER NOT NULL,
    SCHEDULE_DATE           DATE NOT NULL,
    START_TIME              VARCHAR2(8) NOT NULL,
    END_TIME                VARCHAR2(8) NOT NULL,
    SHIFT_TYPE              VARCHAR2(20),
    STATUS                  VARCHAR2(20) DEFAULT 'SCHEDULED' NOT NULL,
    NOTES                   VARCHAR2(1000),
    CREATED_DATE            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_BY              VARCHAR2(100) DEFAULT USER NOT NULL,
    
    CONSTRAINT PK_STAFF_SCHEDULES PRIMARY KEY (SCHEDULE_ID),
    CONSTRAINT FK_SCHEDULES_STAFF FOREIGN KEY (STAFF_ID) REFERENCES STAFF_MEMBERS(STAFF_ID),
    CONSTRAINT FK_SCHEDULES_HOSPITAL FOREIGN KEY (HOSPITAL_ID) REFERENCES HOSPITALS(HOSPITAL_ID),
    CONSTRAINT CK_SHIFT_TYPE CHECK (SHIFT_TYPE IN ('DAY', 'NIGHT', 'EVENING', 'ON_CALL')),
    CONSTRAINT CK_SCHEDULE_STATUS CHECK (STATUS IN ('SCHEDULED', 'COMPLETED', 'CANCELLED', 'NO_SHOW'))
);

CREATE INDEX IDX_SCHEDULES_STAFF_DATE ON STAFF_SCHEDULES(STAFF_ID, SCHEDULE_DATE);

-- ===================================================================
-- 4. CLINICAL DATA TABLES
-- ===================================================================

CREATE TABLE PATIENT_ADMISSIONS (
    ADMISSION_ID            NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                            MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                            INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    PATIENT_ID              NUMBER NOT NULL,
    HOSPITAL_ID             NUMBER NOT NULL,
    ATTENDING_DOCTOR        NUMBER,
    ADMITTED_BY             NUMBER,
    ADMISSION_DATE          TIMESTAMP WITH TIME ZONE NOT NULL,
    DISCHARGE_DATE          TIMESTAMP WITH TIME ZONE,
    ADMISSION_TYPE          VARCHAR2(50) NOT NULL,
    ADMISSION_SOURCE        VARCHAR2(50),
    CHIEF_COMPLAINT         VARCHAR2(1000),
    PRELIMINARY_DIAGNOSIS   VARCHAR2(1000),
    FINAL_DIAGNOSIS         VARCHAR2(1000),
    DISCHARGE_DISPOSITION   VARCHAR2(100),
    ROOM_NUMBER             VARCHAR2(20),
    BED_NUMBER              VARCHAR2(20),
    STATUS                  VARCHAR2(20) DEFAULT 'ADMITTED' NOT NULL,
    CREATED_DATE            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_BY              VARCHAR2(100) DEFAULT USER NOT NULL,
    UPDATED_DATE            TIMESTAMP WITH TIME ZONE,
    UPDATED_BY              VARCHAR2(100),
    
    CONSTRAINT PK_PATIENT_ADMISSIONS PRIMARY KEY (ADMISSION_ID),
    CONSTRAINT FK_ADMISSIONS_PATIENT FOREIGN KEY (PATIENT_ID) REFERENCES PATIENTS(PATIENT_ID),
    CONSTRAINT FK_ADMISSIONS_HOSPITAL FOREIGN KEY (HOSPITAL_ID) REFERENCES HOSPITALS(HOSPITAL_ID),
    CONSTRAINT FK_ADMISSIONS_DOCTOR FOREIGN KEY (ATTENDING_DOCTOR) REFERENCES STAFF_MEMBERS(STAFF_ID),
    CONSTRAINT FK_ADMISSIONS_ADMITTED_BY FOREIGN KEY (ADMITTED_BY) REFERENCES STAFF_MEMBERS(STAFF_ID),
    CONSTRAINT CK_ADMISSION_TYPE CHECK (ADMISSION_TYPE IN ('EMERGENCY', 'ELECTIVE', 'URGENT', 'OBSERVATION')),
    CONSTRAINT CK_ADMISSION_STATUS CHECK (STATUS IN ('ADMITTED', 'DISCHARGED', 'TRANSFERRED', 'DECEASED'))
);

CREATE INDEX IDX_ADMISSIONS_PATIENT ON PATIENT_ADMISSIONS(PATIENT_ID);
CREATE INDEX IDX_ADMISSIONS_DATE ON PATIENT_ADMISSIONS(ADMISSION_DATE);
CREATE INDEX IDX_ADMISSIONS_STATUS ON PATIENT_ADMISSIONS(STATUS);

CREATE TABLE MEDICAL_RECORDS (
    RECORD_ID               NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                            MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                            INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    PATIENT_ID              NUMBER NOT NULL,
    ADMISSION_ID            NUMBER,
    HOSPITAL_ID             NUMBER NOT NULL,
    DOCTOR_ID               NUMBER NOT NULL,
    VISIT_DATE              TIMESTAMP WITH TIME ZONE NOT NULL,
    VISIT_TYPE              VARCHAR2(50),
    CHIEF_COMPLAINT         VARCHAR2(1000),
    HISTORY_OF_PRESENT_ILLNESS CLOB,
    PAST_MEDICAL_HISTORY    CLOB,
    PHYSICAL_EXAMINATION    CLOB,
    ASSESSMENT_AND_PLAN     CLOB,
    DIAGNOSIS_CODE          VARCHAR2(20),
    DIAGNOSIS_DESCRIPTION   VARCHAR2(1000),
    TREATMENT_PLAN          CLOB,
    FOLLOW_UP_INSTRUCTIONS  CLOB,
    STATUS                  VARCHAR2(20) DEFAULT 'ACTIVE' NOT NULL,
    CREATED_DATE            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_BY              VARCHAR2(100) DEFAULT USER NOT NULL,
    UPDATED_DATE            TIMESTAMP WITH TIME ZONE,
    UPDATED_BY              VARCHAR2(100),
    
    CONSTRAINT PK_MEDICAL_RECORDS PRIMARY KEY (RECORD_ID),
    CONSTRAINT FK_RECORDS_PATIENT FOREIGN KEY (PATIENT_ID) REFERENCES PATIENTS(PATIENT_ID),
    CONSTRAINT FK_RECORDS_ADMISSION FOREIGN KEY (ADMISSION_ID) REFERENCES PATIENT_ADMISSIONS(ADMISSION_ID),
    CONSTRAINT FK_RECORDS_HOSPITAL FOREIGN KEY (HOSPITAL_ID) REFERENCES HOSPITALS(HOSPITAL_ID),
    CONSTRAINT FK_RECORDS_DOCTOR FOREIGN KEY (DOCTOR_ID) REFERENCES STAFF_MEMBERS(STAFF_ID)
);

CREATE INDEX IDX_RECORDS_PATIENT ON MEDICAL_RECORDS(PATIENT_ID);
CREATE INDEX IDX_RECORDS_VISIT_DATE ON MEDICAL_RECORDS(VISIT_DATE);

CREATE TABLE VITAL_SIGNS (
    VITAL_ID                    NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                                MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                                INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    PATIENT_ID                  NUMBER NOT NULL,
    ADMISSION_ID                NUMBER,
    HOSPITAL_ID                 NUMBER NOT NULL,
    RECORDED_BY                 NUMBER NOT NULL,
    RECORDED_DATE               TIMESTAMP WITH TIME ZONE NOT NULL,
    TEMPERATURE                 NUMBER(4,1),
    TEMPERATURE_UNIT            VARCHAR2(1) DEFAULT 'C',
    BLOOD_PRESSURE_SYSTOLIC     NUMBER(3,0),
    BLOOD_PRESSURE_DIASTOLIC    NUMBER(3,0),
    HEART_RATE                  NUMBER(3,0),
    RESPIRATORY_RATE            NUMBER(3,0),
    OXYGEN_SATURATION           NUMBER(5,2),
    WEIGHT                      NUMBER(5,2),
    HEIGHT                      NUMBER(5,2),
    BMI_CATEGORY                VARCHAR2(20),
    PAIN_SCALE                  VARCHAR2(20),
    NOTES                       CLOB,
    CREATED_DATE                TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_BY                  VARCHAR2(100) DEFAULT USER NOT NULL,
    
    CONSTRAINT PK_VITAL_SIGNS PRIMARY KEY (VITAL_ID),
    CONSTRAINT FK_VITALS_PATIENT FOREIGN KEY (PATIENT_ID) REFERENCES PATIENTS(PATIENT_ID),
    CONSTRAINT FK_VITALS_ADMISSION FOREIGN KEY (ADMISSION_ID) REFERENCES PATIENT_ADMISSIONS(ADMISSION_ID),
    CONSTRAINT FK_VITALS_HOSPITAL FOREIGN KEY (HOSPITAL_ID) REFERENCES HOSPITALS(HOSPITAL_ID),
    CONSTRAINT FK_VITALS_RECORDED_BY FOREIGN KEY (RECORDED_BY) REFERENCES STAFF_MEMBERS(STAFF_ID),
    CONSTRAINT CK_TEMP_UNIT CHECK (TEMPERATURE_UNIT IN ('C', 'F'))
);

CREATE INDEX IDX_VITALS_PATIENT_DATE ON VITAL_SIGNS(PATIENT_ID, RECORDED_DATE);

-- ===================================================================
-- 5. LABORATORY & DIAGNOSTICS
-- ===================================================================

CREATE TABLE LAB_TESTS (
    TEST_ID                 NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                            MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                            INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    HOSPITAL_ID             NUMBER NOT NULL,
    TEST_CODE               VARCHAR2(50) NOT NULL,
    TEST_NAME               VARCHAR2(200) NOT NULL,
    TEST_CATEGORY           VARCHAR2(100),
    SPECIMEN_TYPE           VARCHAR2(100),
    NORMAL_RANGE_MIN        VARCHAR2(50),
    NORMAL_RANGE_MAX        VARCHAR2(50),
    UNIT_OF_MEASURE         VARCHAR2(50),
    COST                    NUMBER(10,2),
    STATUS                  VARCHAR2(20) DEFAULT 'ACTIVE' NOT NULL,
    CREATED_DATE            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_BY              VARCHAR2(100) DEFAULT USER NOT NULL,
    
    CONSTRAINT PK_LAB_TESTS PRIMARY KEY (TEST_ID),
    CONSTRAINT FK_TESTS_HOSPITAL FOREIGN KEY (HOSPITAL_ID) REFERENCES HOSPITALS(HOSPITAL_ID),
    CONSTRAINT UK_TESTS_CODE UNIQUE (HOSPITAL_ID, TEST_CODE)
);

CREATE INDEX IDX_TESTS_CATEGORY ON LAB_TESTS(TEST_CATEGORY);

CREATE TABLE LAB_ORDERS (
    ORDER_ID                    NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                                MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                                INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    PATIENT_ID                  NUMBER NOT NULL,
    ADMISSION_ID                NUMBER,
    HOSPITAL_ID                 NUMBER NOT NULL,
    DOCTOR_ID                   NUMBER NOT NULL,
    TEST_ID                     NUMBER NOT NULL,
    ORDER_DATE                  TIMESTAMP WITH TIME ZONE NOT NULL,
    SPECIMEN_COLLECTION_DATE    TIMESTAMP WITH TIME ZONE,
    PRIORITY                    VARCHAR2(20) DEFAULT 'ROUTINE',
    SPECIMEN_ID                 VARCHAR2(100),
    CLINICAL_INDICATION         VARCHAR2(1000),
    SPECIAL_INSTRUCTIONS        VARCHAR2(1000),
    ORDER_STATUS                VARCHAR2(20) DEFAULT 'ORDERED' NOT NULL,
    CREATED_DATE                TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_BY                  VARCHAR2(100) DEFAULT USER NOT NULL,
    UPDATED_DATE                TIMESTAMP WITH TIME ZONE,
    UPDATED_BY                  VARCHAR2(100),
    
    CONSTRAINT PK_LAB_ORDERS PRIMARY KEY (ORDER_ID),
    CONSTRAINT FK_ORDERS_PATIENT FOREIGN KEY (PATIENT_ID) REFERENCES PATIENTS(PATIENT_ID),
    CONSTRAINT FK_ORDERS_ADMISSION FOREIGN KEY (ADMISSION_ID) REFERENCES PATIENT_ADMISSIONS(ADMISSION_ID),
    CONSTRAINT FK_ORDERS_HOSPITAL FOREIGN KEY (HOSPITAL_ID) REFERENCES HOSPITALS(HOSPITAL_ID),
    CONSTRAINT FK_ORDERS_DOCTOR FOREIGN KEY (DOCTOR_ID) REFERENCES STAFF_MEMBERS(STAFF_ID),
    CONSTRAINT FK_ORDERS_TEST FOREIGN KEY (TEST_ID) REFERENCES LAB_TESTS(TEST_ID),
    CONSTRAINT CK_ORDER_PRIORITY CHECK (PRIORITY IN ('STAT', 'URGENT', 'ROUTINE')),
    CONSTRAINT CK_ORDER_STATUS CHECK (ORDER_STATUS IN ('ORDERED', 'COLLECTED', 'PROCESSING', 'COMPLETED', 'CANCELLED'))
);

CREATE INDEX IDX_ORDERS_PATIENT ON LAB_ORDERS(PATIENT_ID);
CREATE INDEX IDX_ORDERS_DATE ON LAB_ORDERS(ORDER_DATE);
CREATE INDEX IDX_ORDERS_STATUS ON LAB_ORDERS(ORDER_STATUS);

CREATE TABLE LAB_RESULTS (
    RESULT_ID               NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                            MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                            INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    ORDER_ID                NUMBER NOT NULL,
    HOSPITAL_ID             NUMBER NOT NULL,
    RESULT_VALUE            VARCHAR2(500),
    RESULT_STATUS           VARCHAR2(20) DEFAULT 'PRELIMINARY',
    REFERENCE_RANGE         VARCHAR2(100),
    ABNORMAL_FLAG           VARCHAR2(20),
    RESULT_INTERPRETATION   CLOB,
    RESULT_DATE             TIMESTAMP WITH TIME ZONE NOT NULL,
    TECHNICIAN_ID           NUMBER,
    VERIFIED_BY             NUMBER,
    VERIFIED_DATE           TIMESTAMP WITH TIME ZONE,
    COMMENTS                CLOB,
    CREATED_DATE            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_BY              VARCHAR2(100) DEFAULT USER NOT NULL,
    
    CONSTRAINT PK_LAB_RESULTS PRIMARY KEY (RESULT_ID),
    CONSTRAINT FK_RESULTS_ORDER FOREIGN KEY (ORDER_ID) REFERENCES LAB_ORDERS(ORDER_ID),
    CONSTRAINT FK_RESULTS_HOSPITAL FOREIGN KEY (HOSPITAL_ID) REFERENCES HOSPITALS(HOSPITAL_ID),
    CONSTRAINT FK_RESULTS_TECHNICIAN FOREIGN KEY (TECHNICIAN_ID) REFERENCES STAFF_MEMBERS(STAFF_ID),
    CONSTRAINT FK_RESULTS_VERIFIED_BY FOREIGN KEY (VERIFIED_BY) REFERENCES STAFF_MEMBERS(STAFF_ID),
    CONSTRAINT CK_RESULT_STATUS CHECK (RESULT_STATUS IN ('PRELIMINARY', 'FINAL', 'CORRECTED', 'CANCELLED'))
);

CREATE INDEX IDX_RESULTS_ORDER ON LAB_RESULTS(ORDER_ID);
CREATE INDEX IDX_RESULTS_DATE ON LAB_RESULTS(RESULT_DATE);

-- ===================================================================
-- 6. PHARMACY & MEDICATIONS
-- ===================================================================

CREATE TABLE MEDICATIONS (
    MEDICATION_ID               NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                                MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                                INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    HOSPITAL_ID                 NUMBER NOT NULL,
    MEDICATION_CODE             VARCHAR2(50) NOT NULL,
    MEDICATION_NAME             VARCHAR2(200) NOT NULL,
    GENERIC_NAME                VARCHAR2(200),
    BRAND_NAME                  VARCHAR2(200),
    DOSAGE_FORM                 VARCHAR2(100),
    STRENGTH                    VARCHAR2(100),
    THERAPEUTIC_CLASS           VARCHAR2(200),
    CONTROLLED_SUBSTANCE_SCHEDULE VARCHAR2(10),
    UNIT_COST                   NUMBER(10,2),
    STOCK_QUANTITY              NUMBER(10,0) DEFAULT 0,
    REORDER_LEVEL               NUMBER(10,0),
    EXPIRY_DATE                 DATE,
    MANUFACTURER                VARCHAR2(200),
    BATCH_NUMBER                VARCHAR2(100),
    STATUS                      VARCHAR2(20) DEFAULT 'ACTIVE' NOT NULL,
    CREATED_DATE                TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_BY                  VARCHAR2(100) DEFAULT USER NOT NULL,
    UPDATED_DATE                TIMESTAMP WITH TIME ZONE,
    UPDATED_BY                  VARCHAR2(100),
    
    CONSTRAINT PK_MEDICATIONS PRIMARY KEY (MEDICATION_ID),
    CONSTRAINT FK_MEDICATIONS_HOSPITAL FOREIGN KEY (HOSPITAL_ID) REFERENCES HOSPITALS(HOSPITAL_ID),
    CONSTRAINT UK_MEDICATIONS_CODE UNIQUE (HOSPITAL_ID, MEDICATION_CODE),
    CONSTRAINT CK_MEDICATIONS_STATUS CHECK (STATUS IN ('ACTIVE', 'INACTIVE', 'EXPIRED', 'RECALLED'))
);

CREATE INDEX IDX_MEDICATIONS_HOSPITAL ON MEDICATIONS(HOSPITAL_ID);
CREATE INDEX IDX_MEDICATIONS_EXPIRY ON MEDICATIONS(EXPIRY_DATE);

CREATE TABLE PRESCRIPTIONS (
    PRESCRIPTION_ID         NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                            MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                            INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    PATIENT_ID              NUMBER NOT NULL,
    ADMISSION_ID            NUMBER,
    HOSPITAL_ID             NUMBER NOT NULL,
    DOCTOR_ID               NUMBER NOT NULL,
    MEDICATION_ID           NUMBER NOT NULL,
    PRESCRIPTION_DATE       TIMESTAMP WITH TIME ZONE NOT NULL,
    DOSAGE                  VARCHAR2(200),
    FREQUENCY               VARCHAR2(200),
    ROUTE                   VARCHAR2(100),
    QUANTITY                NUMBER(10,0),
    REFILLS                 NUMBER(3,0) DEFAULT 0,
    SPECIAL_INSTRUCTIONS    CLOB,
    START_DATE              DATE,
    END_DATE                DATE,
    PRESCRIPTION_STATUS     VARCHAR2(20) DEFAULT 'PRESCRIBED' NOT NULL,
    DISPENSED_DATE          TIMESTAMP WITH TIME ZONE,
    DISPENSED_BY            NUMBER,
    DISPENSED_QUANTITY      NUMBER(10,0),
    CREATED_DATE            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_BY              VARCHAR2(100) DEFAULT USER NOT NULL,
    UPDATED_DATE            TIMESTAMP WITH TIME ZONE,
    UPDATED_BY              VARCHAR2(100),
    
    CONSTRAINT PK_PRESCRIPTIONS PRIMARY KEY (PRESCRIPTION_ID),
    CONSTRAINT FK_PRESCRIPTIONS_PATIENT FOREIGN KEY (PATIENT_ID) REFERENCES PATIENTS(PATIENT_ID),
    CONSTRAINT FK_PRESCRIPTIONS_ADMISSION FOREIGN KEY (ADMISSION_ID) REFERENCES PATIENT_ADMISSIONS(ADMISSION_ID),
    CONSTRAINT FK_PRESCRIPTIONS_HOSPITAL FOREIGN KEY (HOSPITAL_ID) REFERENCES HOSPITALS(HOSPITAL_ID),
    CONSTRAINT FK_PRESCRIPTIONS_DOCTOR FOREIGN KEY (DOCTOR_ID) REFERENCES STAFF_MEMBERS(STAFF_ID),
    CONSTRAINT FK_PRESCRIPTIONS_MEDICATION FOREIGN KEY (MEDICATION_ID) REFERENCES MEDICATIONS(MEDICATION_ID),
    CONSTRAINT FK_PRESCRIPTIONS_DISPENSED_BY FOREIGN KEY (DISPENSED_BY) REFERENCES STAFF_MEMBERS(STAFF_ID),
    CONSTRAINT CK_PRESCRIPTION_STATUS CHECK (PRESCRIPTION_STATUS IN ('PRESCRIBED', 'DISPENSED', 'PARTIALLY_DISPENSED', 'CANCELLED', 'EXPIRED'))
);

CREATE INDEX IDX_PRESCRIPTIONS_PATIENT ON PRESCRIPTIONS(PATIENT_ID);
CREATE INDEX IDX_PRESCRIPTIONS_DATE ON PRESCRIPTIONS(PRESCRIPTION_DATE);
CREATE INDEX IDX_PRESCRIPTIONS_STATUS ON PRESCRIPTIONS(PRESCRIPTION_STATUS);

-- ===================================================================
-- 7. PROCEDURES & SURGERY
-- ===================================================================

CREATE TABLE PROCEDURES (
    PROCEDURE_ID            NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                            MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                            INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    HOSPITAL_ID             NUMBER NOT NULL,
    PROCEDURE_CODE          VARCHAR2(50) NOT NULL,
    PROCEDURE_NAME          VARCHAR2(300) NOT NULL,
    PROCEDURE_CATEGORY      VARCHAR2(100),
    PROCEDURE_TYPE          VARCHAR2(100),
    DESCRIPTION             CLOB,
    ESTIMATED_DURATION      NUMBER(10,2),
    BASE_COST               NUMBER(12,2),
    ANESTHESIA_REQUIRED     CHAR(1) DEFAULT 'N',
    STATUS                  VARCHAR2(20) DEFAULT 'ACTIVE' NOT NULL,
    CREATED_DATE            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_BY              VARCHAR2(100) DEFAULT USER NOT NULL,
    
    CONSTRAINT PK_PROCEDURES PRIMARY KEY (PROCEDURE_ID),
    CONSTRAINT FK_PROCEDURES_HOSPITAL FOREIGN KEY (HOSPITAL_ID) REFERENCES HOSPITALS(HOSPITAL_ID),
    CONSTRAINT UK_PROCEDURES_CODE UNIQUE (HOSPITAL_ID, PROCEDURE_CODE),
    CONSTRAINT CK_ANESTHESIA_REQUIRED CHECK (ANESTHESIA_REQUIRED IN ('Y', 'N'))
);

CREATE INDEX IDX_PROCEDURES_HOSPITAL ON PROCEDURES(HOSPITAL_ID);
CREATE INDEX IDX_PROCEDURES_CATEGORY ON PROCEDURES(PROCEDURE_CATEGORY);

CREATE TABLE PATIENT_PROCEDURES (
    PATIENT_PROCEDURE_ID    NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                            MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                            INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    PATIENT_ID              NUMBER NOT NULL,
    ADMISSION_ID            NUMBER,
    HOSPITAL_ID             NUMBER NOT NULL,
    PROCEDURE_ID            NUMBER NOT NULL,
    PRIMARY_SURGEON         NUMBER NOT NULL,
    PROCEDURE_DATE          TIMESTAMP WITH TIME ZONE NOT NULL,
    START_TIME              TIMESTAMP WITH TIME ZONE,
    END_TIME                TIMESTAMP WITH TIME ZONE,
    PROCEDURE_STATUS        VARCHAR2(20) DEFAULT 'SCHEDULED' NOT NULL,
    PRE_PROCEDURE_NOTES     CLOB,
    PROCEDURE_NOTES         CLOB,
    POST_PROCEDURE_NOTES    CLOB,
    COMPLICATIONS           CLOB,
    ANESTHESIA_TYPE         VARCHAR2(100),
    ANESTHESIOLOGIST        NUMBER,
    OPERATING_ROOM          VARCHAR2(50),
    CREATED_DATE            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_BY              VARCHAR2(100) DEFAULT USER NOT NULL,
    UPDATED_DATE            TIMESTAMP WITH TIME ZONE,
    UPDATED_BY              VARCHAR2(100),
    
    CONSTRAINT PK_PATIENT_PROCEDURES PRIMARY KEY (PATIENT_PROCEDURE_ID),
    CONSTRAINT FK_PATIENT_PROC_PATIENT FOREIGN KEY (PATIENT_ID) REFERENCES PATIENTS(PATIENT_ID),
    CONSTRAINT FK_PATIENT_PROC_ADMISSION FOREIGN KEY (ADMISSION_ID) REFERENCES PATIENT_ADMISSIONS(ADMISSION_ID),
    CONSTRAINT FK_PATIENT_PROC_HOSPITAL FOREIGN KEY (HOSPITAL_ID) REFERENCES HOSPITALS(HOSPITAL_ID),
    CONSTRAINT FK_PATIENT_PROC_PROCEDURE FOREIGN KEY (PROCEDURE_ID) REFERENCES PROCEDURES(PROCEDURE_ID),
    CONSTRAINT FK_PATIENT_PROC_SURGEON FOREIGN KEY (PRIMARY_SURGEON) REFERENCES STAFF_MEMBERS(STAFF_ID),
    CONSTRAINT FK_PATIENT_PROC_ANESTHESIOLOGIST FOREIGN KEY (ANESTHESIOLOGIST) REFERENCES STAFF_MEMBERS(STAFF_ID),
    CONSTRAINT CK_PROCEDURE_STATUS CHECK (PROCEDURE_STATUS IN ('SCHEDULED', 'IN_PROGRESS', 'COMPLETED', 'CANCELLED', 'POSTPONED'))
);

CREATE INDEX IDX_PATIENT_PROC_PATIENT ON PATIENT_PROCEDURES(PATIENT_ID);
CREATE INDEX IDX_PATIENT_PROC_DATE ON PATIENT_PROCEDURES(PROCEDURE_DATE);
CREATE INDEX IDX_PATIENT_PROC_STATUS ON PATIENT_PROCEDURES(PROCEDURE_STATUS);

-- ===================================================================
-- 8. FACILITY MANAGEMENT
-- ===================================================================

CREATE TABLE ROOMS (
    ROOM_ID                 NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                            MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                            INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    HOSPITAL_ID             NUMBER NOT NULL,
    DEPARTMENT_ID           NUMBER,
    ROOM_NUMBER             VARCHAR2(20) NOT NULL,
    ROOM_TYPE               VARCHAR2(50) NOT NULL,
    ROOM_STATUS             VARCHAR2(20) DEFAULT 'AVAILABLE' NOT NULL,
    BED_CAPACITY            NUMBER(3,0) DEFAULT 1,
    LOCATION                VARCHAR2(200),
    EQUIPMENT_LIST          CLOB,
    DAILY_RATE              NUMBER(10,2),
    SPECIAL_FEATURES        VARCHAR2(1000),
    CREATED_DATE            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_BY              VARCHAR2(100) DEFAULT USER NOT NULL,
    UPDATED_DATE            TIMESTAMP WITH TIME ZONE,
    UPDATED_BY              VARCHAR2(100),
    
    CONSTRAINT PK_ROOMS PRIMARY KEY (ROOM_ID),
    CONSTRAINT FK_ROOMS_HOSPITAL FOREIGN KEY (HOSPITAL_ID) REFERENCES HOSPITALS(HOSPITAL_ID),
    CONSTRAINT FK_ROOMS_DEPARTMENT FOREIGN KEY (DEPARTMENT_ID) REFERENCES DEPARTMENTS(DEPARTMENT_ID),
    CONSTRAINT UK_ROOMS_NUMBER UNIQUE (HOSPITAL_ID, ROOM_NUMBER),
    CONSTRAINT CK_ROOM_TYPE CHECK (ROOM_TYPE IN ('GENERAL', 'PRIVATE', 'ICU', 'CCU', 'OR', 'ER', 'MATERNITY', 'PEDIATRIC')),
    CONSTRAINT CK_ROOM_STATUS CHECK (ROOM_STATUS IN ('AVAILABLE', 'OCCUPIED', 'MAINTENANCE', 'OUT_OF_SERVICE'))
);

CREATE INDEX IDX_ROOMS_HOSPITAL ON ROOMS(HOSPITAL_ID);
CREATE INDEX IDX_ROOMS_TYPE ON ROOMS(ROOM_TYPE);
CREATE INDEX IDX_ROOMS_STATUS ON ROOMS(ROOM_STATUS);

CREATE TABLE BEDS (
    BED_ID                  NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                            MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                            INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    ROOM_ID                 NUMBER NOT NULL,
    HOSPITAL_ID             NUMBER NOT NULL,
    BED_NUMBER              VARCHAR2(20) NOT NULL,
    BED_TYPE                VARCHAR2(50),
    BED_STATUS              VARCHAR2(20) DEFAULT 'AVAILABLE' NOT NULL,
    CURRENT_PATIENT_ID      NUMBER,
    OCCUPIED_SINCE          TIMESTAMP WITH TIME ZONE,
    SPECIAL_EQUIPMENT       VARCHAR2(1000),
    CREATED_DATE            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_BY              VARCHAR2(100) DEFAULT USER NOT NULL,
    UPDATED_DATE            TIMESTAMP WITH TIME ZONE,
    UPDATED_BY              VARCHAR2(100),
    
    CONSTRAINT PK_BEDS PRIMARY KEY (BED_ID),
    CONSTRAINT FK_BEDS_ROOM FOREIGN KEY (ROOM_ID) REFERENCES ROOMS(ROOM_ID),
    CONSTRAINT FK_BEDS_HOSPITAL FOREIGN KEY (HOSPITAL_ID) REFERENCES HOSPITALS(HOSPITAL_ID),
    CONSTRAINT FK_BEDS_PATIENT FOREIGN KEY (CURRENT_PATIENT_ID) REFERENCES PATIENTS(PATIENT_ID),
    CONSTRAINT UK_BEDS_NUMBER UNIQUE (HOSPITAL_ID, BED_NUMBER),
    CONSTRAINT CK_BED_STATUS CHECK (BED_STATUS IN ('AVAILABLE', 'OCCUPIED', 'CLEANING', 'MAINTENANCE', 'OUT_OF_SERVICE'))
);

CREATE INDEX IDX_BEDS_ROOM ON BEDS(ROOM_ID);
CREATE INDEX IDX_BEDS_STATUS ON BEDS(BED_STATUS);
CREATE INDEX IDX_BEDS_PATIENT ON BEDS(CURRENT_PATIENT_ID);

CREATE TABLE MEDICAL_EQUIPMENT (
    EQUIPMENT_ID            NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                            MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                            INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    HOSPITAL_ID             NUMBER NOT NULL,
    DEPARTMENT_ID           NUMBER,
    EQUIPMENT_CODE          VARCHAR2(50) NOT NULL,
    EQUIPMENT_NAME          VARCHAR2(200) NOT NULL,
    EQUIPMENT_TYPE          VARCHAR2(100),
    MANUFACTURER            VARCHAR2(200),
    MODEL_NUMBER            VARCHAR2(100),
    SERIAL_NUMBER           VARCHAR2(100),
    PURCHASE_DATE           DATE,
    PURCHASE_COST           NUMBER(12,2),
    WARRANTY_EXPIRY         DATE,
    LAST_MAINTENANCE_DATE   DATE,
    NEXT_MAINTENANCE_DATE   DATE,
    MAINTENANCE_SCHEDULE    VARCHAR2(100),
    EQUIPMENT_STATUS        VARCHAR2(20) DEFAULT 'ACTIVE' NOT NULL,
    LOCATION                VARCHAR2(200),
    ASSIGNED_TO             NUMBER,
    CREATED_DATE            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_BY              VARCHAR2(100) DEFAULT USER NOT NULL,
    UPDATED_DATE            TIMESTAMP WITH TIME ZONE,
    UPDATED_BY              VARCHAR2(100),
    
    CONSTRAINT PK_MEDICAL_EQUIPMENT PRIMARY KEY (EQUIPMENT_ID),
    CONSTRAINT FK_EQUIPMENT_HOSPITAL FOREIGN KEY (HOSPITAL_ID) REFERENCES HOSPITALS(HOSPITAL_ID),
    CONSTRAINT FK_EQUIPMENT_DEPARTMENT FOREIGN KEY (DEPARTMENT_ID) REFERENCES DEPARTMENTS(DEPARTMENT_ID),
    CONSTRAINT FK_EQUIPMENT_ASSIGNED_TO FOREIGN KEY (ASSIGNED_TO) REFERENCES STAFF_MEMBERS(STAFF_ID),
    CONSTRAINT UK_EQUIPMENT_CODE UNIQUE (HOSPITAL_ID, EQUIPMENT_CODE),
    CONSTRAINT CK_EQUIPMENT_STATUS CHECK (EQUIPMENT_STATUS IN ('ACTIVE', 'MAINTENANCE', 'OUT_OF_SERVICE', 'RETIRED'))
);

CREATE INDEX IDX_EQUIPMENT_HOSPITAL ON MEDICAL_EQUIPMENT(HOSPITAL_ID);
CREATE INDEX IDX_EQUIPMENT_TYPE ON MEDICAL_EQUIPMENT(EQUIPMENT_TYPE);
CREATE INDEX IDX_EQUIPMENT_STATUS ON MEDICAL_EQUIPMENT(EQUIPMENT_STATUS);

-- ===================================================================
-- 9. FINANCIAL MANAGEMENT
-- ===================================================================

CREATE TABLE BILLING (
    BILL_ID                 NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                            MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                            INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    PATIENT_ID              NUMBER NOT NULL,
    ADMISSION_ID            NUMBER,
    HOSPITAL_ID             NUMBER NOT NULL,
    BILL_NUMBER             VARCHAR2(50) NOT NULL,
    BILL_DATE               TIMESTAMP WITH TIME ZONE NOT NULL,
    TOTAL_AMOUNT            NUMBER(12,2) NOT NULL,
    INSURANCE_AMOUNT        NUMBER(12,2) DEFAULT 0,
    PATIENT_AMOUNT          NUMBER(12,2) NOT NULL,
    DISCOUNT_AMOUNT         NUMBER(12,2) DEFAULT 0,
    TAX_AMOUNT              NUMBER(12,2) DEFAULT 0,
    BILLING_STATUS          VARCHAR2(20) DEFAULT 'PENDING' NOT NULL,
    DUE_DATE                DATE,
    PAYMENT_DATE            TIMESTAMP WITH TIME ZONE,
    PAYMENT_METHOD          VARCHAR2(50),
    PAYMENT_REFERENCE       VARCHAR2(100),
    BILLING_NOTES           CLOB,
    CREATED_DATE            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_BY              VARCHAR2(100) DEFAULT USER NOT NULL,
    UPDATED_DATE            TIMESTAMP WITH TIME ZONE,
    UPDATED_BY              VARCHAR2(100),
    
    CONSTRAINT PK_BILLING PRIMARY KEY (BILL_ID),
    CONSTRAINT FK_BILLING_PATIENT FOREIGN KEY (PATIENT_ID) REFERENCES PATIENTS(PATIENT_ID),
    CONSTRAINT FK_BILLING_ADMISSION FOREIGN KEY (ADMISSION_ID) REFERENCES PATIENT_ADMISSIONS(ADMISSION_ID),
    CONSTRAINT FK_BILLING_HOSPITAL FOREIGN KEY (HOSPITAL_ID) REFERENCES HOSPITALS(HOSPITAL_ID),
    CONSTRAINT UK_BILLING_NUMBER UNIQUE (HOSPITAL_ID, BILL_NUMBER),
    CONSTRAINT CK_BILLING_STATUS CHECK (BILLING_STATUS IN ('PENDING', 'PARTIAL_PAID', 'PAID', 'OVERDUE', 'CANCELLED')),
    CONSTRAINT CK_BILLING_AMOUNTS CHECK (TOTAL_AMOUNT >= 0 AND PATIENT_AMOUNT >= 0)
);

CREATE INDEX IDX_BILLING_PATIENT ON BILLING(PATIENT_ID);
CREATE INDEX IDX_BILLING_DATE ON BILLING(BILL_DATE);
CREATE INDEX IDX_BILLING_STATUS ON BILLING(BILLING_STATUS);

CREATE TABLE BILLING_ITEMS (
    BILLING_ITEM_ID         NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                            MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                            INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    BILL_ID                 NUMBER NOT NULL,
    HOSPITAL_ID             NUMBER NOT NULL,
    ITEM_TYPE               VARCHAR2(50) NOT NULL,
    ITEM_CODE               VARCHAR2(50),
    ITEM_DESCRIPTION        VARCHAR2(500) NOT NULL,
    QUANTITY                NUMBER(10,2) DEFAULT 1,
    UNIT_PRICE              NUMBER(12,2) NOT NULL,
    TOTAL_PRICE             NUMBER(12,2) NOT NULL,
    DISCOUNT_PERCENTAGE     NUMBER(5,2) DEFAULT 0,
    DISCOUNT_AMOUNT         NUMBER(12,2) DEFAULT 0,
    BILLING_CATEGORY        VARCHAR2(100),
    CREATED_DATE            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_BY              VARCHAR2(100) DEFAULT USER NOT NULL,
    
    CONSTRAINT PK_BILLING_ITEMS PRIMARY KEY (BILLING_ITEM_ID),
    CONSTRAINT FK_BILLING_ITEMS_BILL FOREIGN KEY (BILL_ID) REFERENCES BILLING(BILL_ID) ON DELETE CASCADE,
    CONSTRAINT FK_BILLING_ITEMS_HOSPITAL FOREIGN KEY (HOSPITAL_ID) REFERENCES HOSPITALS(HOSPITAL_ID),
    CONSTRAINT CK_ITEM_TYPE CHECK (ITEM_TYPE IN ('ROOM', 'PROCEDURE', 'MEDICATION', 'LAB_TEST', 'CONSULTATION', 'EQUIPMENT', 'OTHER')),
    CONSTRAINT CK_BILLING_QUANTITIES CHECK (QUANTITY > 0 AND UNIT_PRICE >= 0)
);

CREATE INDEX IDX_BILLING_ITEMS_BILL ON BILLING_ITEMS(BILL_ID);
CREATE INDEX IDX_BILLING_ITEMS_TYPE ON BILLING_ITEMS(ITEM_TYPE);

-- ===================================================================
-- 10. AI/ML RELATED TABLES
-- ===================================================================

CREATE TABLE AI_CLASSIFICATIONS (
    CLASSIFICATION_ID       NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                            MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                            INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    PATIENT_ID              NUMBER NOT NULL,
    HOSPITAL_ID             NUMBER NOT NULL,
    CLASSIFICATION_TYPE     VARCHAR2(100) NOT NULL,
    INPUT_DATA_TYPE         VARCHAR2(50) NOT NULL,
    INPUT_DATA              CLOB,
    MODEL_NAME              VARCHAR2(200) NOT NULL,
    MODEL_VERSION           VARCHAR2(50),
    CLASSIFICATION_RESULT   CLOB,
    CONFIDENCE_SCORE        NUMBER(5,4),
    ICD_10_CODE             VARCHAR2(20),
    DIAGNOSIS_CATEGORY      VARCHAR2(200),
    RISK_LEVEL              VARCHAR2(20),
    CLASSIFICATION_DATE     TIMESTAMP WITH TIME ZONE NOT NULL,
    CLASSIFICATION_STATUS   VARCHAR2(20) DEFAULT 'PENDING' NOT NULL,
    VALIDATED_BY            NUMBER,
    VALIDATION_DATE         TIMESTAMP WITH TIME ZONE,
    VALIDATION_STATUS       VARCHAR2(20),
    CREATED_DATE            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_BY              VARCHAR2(100) DEFAULT USER NOT NULL,
    
    CONSTRAINT PK_AI_CLASSIFICATIONS PRIMARY KEY (CLASSIFICATION_ID),
    CONSTRAINT FK_AI_CLASS_PATIENT FOREIGN KEY (PATIENT_ID) REFERENCES PATIENTS(PATIENT_ID),
    CONSTRAINT FK_AI_CLASS_HOSPITAL FOREIGN KEY (HOSPITAL_ID) REFERENCES HOSPITALS(HOSPITAL_ID),
    CONSTRAINT FK_AI_CLASS_VALIDATED_BY FOREIGN KEY (VALIDATED_BY) REFERENCES STAFF_MEMBERS(STAFF_ID),
    CONSTRAINT CK_AI_CLASS_TYPE CHECK (CLASSIFICATION_TYPE IN ('DIAGNOSIS', 'RISK_ASSESSMENT', 'TRIAGE', 'RADIOLOGY', 'PATHOLOGY')),
    CONSTRAINT CK_AI_CLASS_INPUT_TYPE CHECK (INPUT_DATA_TYPE IN ('TEXT', 'IMAGE', 'STRUCTURED_DATA', 'SIGNAL')),
    CONSTRAINT CK_AI_RISK_LEVEL CHECK (RISK_LEVEL IN ('LOW', 'MODERATE', 'HIGH', 'CRITICAL')),
    CONSTRAINT CK_CONFIDENCE_SCORE CHECK (CONFIDENCE_SCORE >= 0 AND CONFIDENCE_SCORE <= 1)
);

CREATE INDEX IDX_AI_CLASS_PATIENT ON AI_CLASSIFICATIONS(PATIENT_ID);
CREATE INDEX IDX_AI_CLASS_DATE ON AI_CLASSIFICATIONS(CLASSIFICATION_DATE);
CREATE INDEX IDX_AI_CLASS_TYPE ON AI_CLASSIFICATIONS(CLASSIFICATION_TYPE);

CREATE TABLE AI_PREDICTIONS (
    PREDICTION_ID           NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                            MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                            INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    PATIENT_ID              NUMBER NOT NULL,
    ADMISSION_ID            NUMBER,
    HOSPITAL_ID             NUMBER NOT NULL,
    PREDICTION_TYPE         VARCHAR2(100) NOT NULL,
    MODEL_NAME              VARCHAR2(200) NOT NULL,
    MODEL_VERSION           VARCHAR2(50),
    INPUT_FEATURES          CLOB,
    PREDICTION_RESULT       CLOB,
    CONFIDENCE_SCORE        NUMBER(5,4),
    RISK_PROBABILITY        NUMBER(5,4),
    PREDICTED_LOS_DAYS      NUMBER(5,0),
    READMISSION_RISK        VARCHAR2(20),
    TREATMENT_RECOMMENDATION CLOB,
    PREDICTION_DATE         TIMESTAMP WITH TIME ZONE NOT NULL,
    PREDICTION_TARGET_DATE  DATE,
    PREDICTION_STATUS       VARCHAR2(20) DEFAULT 'ACTIVE' NOT NULL,
    ACTUAL_OUTCOME          VARCHAR2(200),
    OUTCOME_DATE            TIMESTAMP WITH TIME ZONE,
    ACCURACY_SCORE          NUMBER(5,4),
    CREATED_DATE            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_BY              VARCHAR2(100) DEFAULT USER NOT NULL,
    UPDATED_DATE            TIMESTAMP WITH TIME ZONE,
    UPDATED_BY              VARCHAR2(100),
    
    CONSTRAINT PK_AI_PREDICTIONS PRIMARY KEY (PREDICTION_ID),
    CONSTRAINT FK_AI_PRED_PATIENT FOREIGN KEY (PATIENT_ID) REFERENCES PATIENTS(PATIENT_ID),
    CONSTRAINT FK_AI_PRED_ADMISSION FOREIGN KEY (ADMISSION_ID) REFERENCES PATIENT_ADMISSIONS(ADMISSION_ID),
    CONSTRAINT FK_AI_PRED_HOSPITAL FOREIGN KEY (HOSPITAL_ID) REFERENCES HOSPITALS(HOSPITAL_ID),
    CONSTRAINT CK_AI_PRED_TYPE CHECK (PREDICTION_TYPE IN ('READMISSION', 'LENGTH_OF_STAY', 'MORTALITY', 'COMPLICATION', 'TREATMENT_RESPONSE')),
    CONSTRAINT CK_READMISSION_RISK CHECK (READMISSION_RISK IN ('LOW', 'MODERATE', 'HIGH')),
    CONSTRAINT CK_AI_PRED_SCORES CHECK (CONFIDENCE_SCORE >= 0 AND CONFIDENCE_SCORE <= 1 AND RISK_PROBABILITY >= 0 AND RISK_PROBABILITY <= 1)
);

CREATE INDEX IDX_AI_PRED_PATIENT ON AI_PREDICTIONS(PATIENT_ID);
CREATE INDEX IDX_AI_PRED_DATE ON AI_PREDICTIONS(PREDICTION_DATE);
CREATE INDEX IDX_AI_PRED_TYPE ON AI_PREDICTIONS(PREDICTION_TYPE);

CREATE TABLE ML_MODEL_METADATA (
    MODEL_ID                NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                            MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                            INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    HOSPITAL_ID             NUMBER NOT NULL,
    MODEL_NAME              VARCHAR2(200) NOT NULL,
    MODEL_TYPE              VARCHAR2(100) NOT NULL,
    MODEL_PURPOSE           VARCHAR2(200),
    ALGORITHM_TYPE          VARCHAR2(100),
    MODEL_VERSION           VARCHAR2(50),
    TRAINING_DATE           DATE,
    DEPLOYMENT_DATE         DATE,
    ACCURACY_SCORE          NUMBER(5,4),
    PRECISION_SCORE         NUMBER(5,4),
    RECALL_SCORE            NUMBER(5,4),
    F1_SCORE                NUMBER(5,4),
    TRAINING_DATASET_INFO   CLOB,
    MODEL_PARAMETERS        CLOB,
    MODEL_STATUS            VARCHAR2(20) DEFAULT 'DEVELOPMENT' NOT NULL,
    MODEL_FILE_PATH         VARCHAR2(500),
    CREATED_DATE            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_BY              VARCHAR2(100) DEFAULT USER NOT NULL,
    UPDATED_DATE            TIMESTAMP WITH TIME ZONE,
    UPDATED_BY              VARCHAR2(100),
    
    CONSTRAINT PK_ML_MODEL_METADATA PRIMARY KEY (MODEL_ID),
    CONSTRAINT FK_ML_MODEL_HOSPITAL FOREIGN KEY (HOSPITAL_ID) REFERENCES HOSPITALS(HOSPITAL_ID),
    CONSTRAINT UK_ML_MODEL_NAME UNIQUE (HOSPITAL_ID, MODEL_NAME),
    CONSTRAINT CK_ML_MODEL_TYPE CHECK (MODEL_TYPE IN ('CLASSIFICATION', 'REGRESSION', 'CLUSTERING', 'NEURAL_NETWORK', 'ENSEMBLE')),
    CONSTRAINT CK_ML_MODEL_STATUS CHECK (MODEL_STATUS IN ('DEVELOPMENT', 'TESTING', 'PRODUCTION', 'RETIRED'))
);

CREATE INDEX IDX_ML_MODEL_HOSPITAL ON ML_MODEL_METADATA(HOSPITAL_ID);
CREATE INDEX IDX_ML_MODEL_STATUS ON ML_MODEL_METADATA(MODEL_STATUS);

-- ===================================================================
-- 11. SYSTEM & AUDIT TABLES
-- ===================================================================

CREATE TABLE AUDIT_TRAIL (
    AUDIT_ID                NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                            MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                            INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    HOSPITAL_ID             NUMBER NOT NULL,
    TABLE_NAME              VARCHAR2(128) NOT NULL,
    OPERATION_TYPE          VARCHAR2(20) NOT NULL,
    RECORD_ID               VARCHAR2(100),
    USER_ID                 VARCHAR2(100) NOT NULL,
    USER_ROLE               VARCHAR2(100),
    OPERATION_DATE          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    OLD_VALUES              CLOB,
    NEW_VALUES              CLOB,
    IP_ADDRESS              VARCHAR2(50),
    SESSION_ID              VARCHAR2(128),
    APPLICATION_NAME        VARCHAR2(100),
    OPERATION_DESCRIPTION   CLOB,
    CREATED_DATE            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    
    CONSTRAINT PK_AUDIT_TRAIL PRIMARY KEY (AUDIT_ID),
    CONSTRAINT FK_AUDIT_HOSPITAL FOREIGN KEY (HOSPITAL_ID) REFERENCES HOSPITALS(HOSPITAL_ID),
    CONSTRAINT CK_OPERATION_TYPE CHECK (OPERATION_TYPE IN ('INSERT', 'UPDATE', 'DELETE', 'SELECT', 'LOGIN', 'LOGOUT'))
);

CREATE INDEX IDX_AUDIT_TABLE_DATE ON AUDIT_TRAIL(TABLE_NAME, OPERATION_DATE);
CREATE INDEX IDX_AUDIT_USER_DATE ON AUDIT_TRAIL(USER_ID, OPERATION_DATE);
CREATE INDEX IDX_AUDIT_OPERATION_TYPE ON AUDIT_TRAIL(OPERATION_TYPE);

CREATE TABLE SYSTEM_CONFIGURATIONS (
    CONFIG_ID               NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY 
                            MINVALUE 1 MAXVALUE 9999999999999999999999999999 
                            INCREMENT BY 1 START WITH 1 CACHE 20 NOT NULL,
    HOSPITAL_ID             NUMBER NOT NULL,
    CONFIG_CATEGORY         VARCHAR2(100) NOT NULL,
    CONFIG_KEY              VARCHAR2(200) NOT NULL,
    CONFIG_VALUE            CLOB,
    DATA_TYPE               VARCHAR2(50) DEFAULT 'STRING',
    DESCRIPTION             VARCHAR2(1000),
    IS_SENSITIVE            CHAR(1) DEFAULT 'N',
    STATUS                  VARCHAR2(20) DEFAULT 'ACTIVE' NOT NULL,
    CREATED_DATE            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_BY              VARCHAR2(100) DEFAULT USER NOT NULL,
    UPDATED_DATE            TIMESTAMP WITH TIME ZONE,
    UPDATED_BY              VARCHAR2(100),
    
    CONSTRAINT PK_SYSTEM_CONFIGURATIONS PRIMARY KEY (CONFIG_ID),
    CONSTRAINT FK_CONFIG_HOSPITAL FOREIGN KEY (HOSPITAL_ID) REFERENCES HOSPITALS(HOSPITAL_ID),
    CONSTRAINT UK_CONFIG_KEY UNIQUE (HOSPITAL_ID, CONFIG_KEY),
    CONSTRAINT CK_DATA_TYPE CHECK (DATA_TYPE IN ('STRING', 'NUMBER', 'BOOLEAN', 'DATE', 'JSON')),
    CONSTRAINT CK_IS_SENSITIVE CHECK (IS_SENSITIVE IN ('Y', 'N'))
);

CREATE INDEX IDX_CONFIG_HOSPITAL ON SYSTEM_CONFIGURATIONS(HOSPITAL_ID);
CREATE INDEX IDX_CONFIG_CATEGORY ON SYSTEM_CONFIGURATIONS(CONFIG_CATEGORY);

-- ===================================================================
-- 12. TRIGGERS FOR AUDIT TRAIL AND BUSINESS LOGIC
-- ===================================================================

-- Generic audit trigger procedure
CREATE OR REPLACE PROCEDURE INSERT_AUDIT_RECORD (
    p_hospital_id       IN NUMBER,
    p_table_name        IN VARCHAR2,
    p_operation_type    IN VARCHAR2,
    p_record_id         IN VARCHAR2,
    p_old_values        IN CLOB DEFAULT NULL,
    p_new_values        IN CLOB DEFAULT NULL
) IS
    PRAGMA AUTONOMOUS_TRANSACTION;
BEGIN
    INSERT INTO AUDIT_TRAIL (
        HOSPITAL_ID, TABLE_NAME, OPERATION_TYPE, RECORD_ID,
        USER_ID, OPERATION_DATE, OLD_VALUES, NEW_VALUES,
        IP_ADDRESS, SESSION_ID, APPLICATION_NAME
    ) VALUES (
        p_hospital_id, p_table_name, p_operation_type, p_record_id,
        COALESCE(SYS_CONTEXT('APEX$SESSION', 'APP_USER'), USER),
        CURRENT_TIMESTAMP, p_old_values, p_new_values,
        SYS_CONTEXT('USERENV', 'IP_ADDRESS'),
        SYS_CONTEXT('USERENV', 'SESSIONID'),
        SYS_CONTEXT('USERENV', 'MODULE')
    );
    COMMIT;
END;
/

-- Patient audit trigger
CREATE OR REPLACE TRIGGER TRG_PATIENTS_AUDIT
AFTER INSERT OR UPDATE OR DELETE ON PATIENTS
FOR EACH ROW
DECLARE
    v_operation VARCHAR2(10);
    v_old_values CLOB;
    v_new_values CLOB;
BEGIN
    IF INSERTING THEN
        v_operation := 'INSERT';
        v_new_values := 'PATIENT_ID=' || :NEW.PATIENT_ID || CHR(10) ||
                       'PATIENT_NUMBER=' || :NEW.PATIENT_NUMBER || CHR(10) ||
                       'NAME=' || :NEW.FIRST_NAME || ' ' || :NEW.LAST_NAME;
        INSERT_AUDIT_RECORD(:NEW.HOSPITAL_ID, 'PATIENTS', v_operation, 
                           TO_CHAR(:NEW.PATIENT_ID), NULL, v_new_values);
    ELSIF UPDATING THEN
        v_operation := 'UPDATE';
        v_old_values := 'PATIENT_ID=' || :OLD.PATIENT_ID || CHR(10) ||
                       'STATUS=' || :OLD.STATUS;
        v_new_values := 'PATIENT_ID=' || :NEW.PATIENT_ID || CHR(10) ||
                       'STATUS=' || :NEW.STATUS;
        INSERT_AUDIT_RECORD(:NEW.HOSPITAL_ID, 'PATIENTS', v_operation, 
                           TO_CHAR(:NEW.PATIENT_ID), v_old_values, v_new_values);
    ELSIF DELETING THEN
        v_operation := 'DELETE';
        v_old_values := 'PATIENT_ID=' || :OLD.PATIENT_ID || CHR(10) ||
                       'PATIENT_NUMBER=' || :OLD.PATIENT_NUMBER;
        INSERT_AUDIT_RECORD(:OLD.HOSPITAL_ID, 'PATIENTS', v_operation, 
                           TO_CHAR(:OLD.PATIENT_ID), v_old_values, NULL);
    END IF;
END;
/

-- Standard BIU triggers for maintaining created/updated timestamps
CREATE OR REPLACE TRIGGER TRG_HOSPITALS_BIU
BEFORE INSERT OR UPDATE ON HOSPITALS
FOR EACH ROW
BEGIN
    IF INSERTING THEN
        :NEW.CREATED_DATE := CURRENT_TIMESTAMP;
        :NEW.CREATED_BY := COALESCE(SYS_CONTEXT('APEX$SESSION', 'APP_USER'), USER);
    END IF;
    IF UPDATING THEN
        :NEW.UPDATED_DATE := CURRENT_TIMESTAMP;
        :NEW.UPDATED_BY := COALESCE(SYS_CONTEXT('APEX$SESSION', 'APP_USER'), USER);
    END IF;
END;
/

CREATE OR REPLACE TRIGGER TRG_PATIENTS_BIU
BEFORE INSERT OR UPDATE ON PATIENTS
FOR EACH ROW
BEGIN
    IF INSERTING THEN
        :NEW.CREATED_DATE := CURRENT_TIMESTAMP;
        :NEW.CREATED_BY := COALESCE(SYS_CONTEXT('APEX$SESSION', 'APP_USER'), USER);
        -- Generate patient number if not provided
        IF :NEW.PATIENT_NUMBER IS NULL THEN
            SELECT 'P' || TO_CHAR(SYSDATE, 'YYYYMMDD') || '-' || 
                   LPAD(HOSPITALS_PATIENT_SEQ.NEXTVAL, 6, '0')
            INTO :NEW.PATIENT_NUMBER
            FROM DUAL;
        END IF;
        -- Generate medical record number if not provided
        IF :NEW.MEDICAL_RECORD_NUMBER IS NULL THEN
            SELECT 'MRN' || TO_CHAR(SYSDATE, 'YYYYMMDD') || '-' || 
                   LPAD(HOSPITALS_MRN_SEQ.NEXTVAL, 6, '0')
            INTO :NEW.MEDICAL_RECORD_NUMBER
            FROM DUAL;
        END IF;
    END IF;
    IF UPDATING THEN
        :NEW.UPDATED_DATE := CURRENT_TIMESTAMP;
        :NEW.UPDATED_BY := COALESCE(SYS_CONTEXT('APEX$SESSION', 'APP_USER'), USER);
    END IF;
END;
/

-- ===================================================================
-- 13. SEQUENCES FOR DOCUMENT NUMBER GENERATION
-- ===================================================================

CREATE SEQUENCE HOSPITALS_MRN_SEQ
START WITH 1
INCREMENT BY 1
NOCACHE
NOCYCLE;

CREATE SEQUENCE HOSPITALS_BILL_SEQ
START WITH 1
INCREMENT BY 1
NOCACHE
NOCYCLE;

-- ===================================================================
-- 14. VIEWS FOR COMMON QUERIES AND REPORTING
-- ===================================================================

-- Patient summary view with latest admission
CREATE OR REPLACE VIEW V_PATIENT_SUMMARY AS
SELECT 
    p.PATIENT_ID,
    p.HOSPITAL_ID,
    h.HOSPITAL_NAME,
    p.PATIENT_NUMBER,
    p.MEDICAL_RECORD_NUMBER,
    p.FIRST_NAME || ' ' || NVL(p.MIDDLE_NAME || ' ', '') || p.LAST_NAME AS FULL_NAME,
    p.DATE_OF_BIRTH,
    FLOOR(MONTHS_BETWEEN(SYSDATE, p.DATE_OF_BIRTH) / 12) AS AGE,
    p.GENDER,
    p.BLOOD_TYPE,
    p.PHONE,
    p.EMAIL,
    p.STATUS AS PATIENT_STATUS,
    pa.ADMISSION_ID AS LATEST_ADMISSION_ID,
    pa.ADMISSION_DATE AS LATEST_ADMISSION_DATE,
    pa.STATUS AS ADMISSION_STATUS,
    pa.ROOM_NUMBER,
    pa.BED_NUMBER,
    sm.FIRST_NAME || ' ' || sm.LAST_NAME AS ATTENDING_DOCTOR_NAME,
    COUNT(pall.ALLERGY_ID) AS ALLERGY_COUNT,
    COUNT(pins.INSURANCE_ID) AS INSURANCE_COUNT
FROM PATIENTS p
INNER JOIN HOSPITALS h ON p.HOSPITAL_ID = h.HOSPITAL_ID
LEFT JOIN (
    SELECT PATIENT_ID, ADMISSION_ID, ADMISSION_DATE, STATUS, ROOM_NUMBER, BED_NUMBER, ATTENDING_DOCTOR,
           ROW_NUMBER() OVER (PARTITION BY PATIENT_ID ORDER BY ADMISSION_DATE DESC) as rn
    FROM PATIENT_ADMISSIONS
) pa ON p.PATIENT_ID = pa.PATIENT_ID AND pa.rn = 1
LEFT JOIN STAFF_MEMBERS sm ON pa.ATTENDING_DOCTOR = sm.STAFF_ID
LEFT JOIN PATIENT_ALLERGIES pall ON p.PATIENT_ID = pall.PATIENT_ID AND pall.STATUS = 'ACTIVE'
LEFT JOIN PATIENT_INSURANCE pins ON p.PATIENT_ID = pins.PATIENT_ID AND pins.STATUS = 'ACTIVE'
WHERE p.STATUS = 'ACTIVE'
GROUP BY p.PATIENT_ID, p.HOSPITAL_ID, h.HOSPITAL_NAME, p.PATIENT_NUMBER, p.MEDICAL_RECORD_NUMBER,
         p.FIRST_NAME, p.MIDDLE_NAME, p.LAST_NAME, p.DATE_OF_BIRTH, p.GENDER, p.BLOOD_TYPE,
         p.PHONE, p.EMAIL, p.STATUS, pa.ADMISSION_ID, pa.ADMISSION_DATE, pa.STATUS,
         pa.ROOM_NUMBER, pa.BED_NUMBER, sm.FIRST_NAME, sm.LAST_NAME;

-- Active admissions dashboard view
CREATE OR REPLACE VIEW V_ACTIVE_ADMISSIONS AS
SELECT 
    pa.ADMISSION_ID,
    pa.HOSPITAL_ID,
    h.HOSPITAL_NAME,
    pa.PATIENT_ID,
    p.PATIENT_NUMBER,
    p.FIRST_NAME || ' ' || p.LAST_NAME AS PATIENT_NAME,
    pa.ADMISSION_DATE,
    FLOOR((SYSDATE - pa.ADMISSION_DATE)) AS LENGTH_OF_STAY_DAYS,
    pa.ADMISSION_TYPE,
    pa.CHIEF_COMPLAINT,
    pa.PRELIMINARY_DIAGNOSIS,
    pa.ROOM_NUMBER,
    pa.BED_NUMBER,
    sm.FIRST_NAME || ' ' || sm.LAST_NAME AS ATTENDING_DOCTOR,
    sm.SPECIALIZATION,
    d.DEPARTMENT_NAME,
    vs.RECORDED_DATE AS LAST_VITALS_DATE,
    vs.TEMPERATURE,
    vs.BLOOD_PRESSURE_SYSTOLIC || '/' || vs.BLOOD_PRESSURE_DIASTOLIC AS BLOOD_PRESSURE,
    vs.HEART_RATE,
    COUNT(lo.ORDER_ID) AS PENDING_LAB_ORDERS,
    COUNT(pr.PRESCRIPTION_ID) AS ACTIVE_PRESCRIPTIONS
FROM PATIENT_ADMISSIONS pa
INNER JOIN HOSPITALS h ON pa.HOSPITAL_ID = h.HOSPITAL_ID
INNER JOIN PATIENTS p ON pa.PATIENT_ID = p.PATIENT_ID
LEFT JOIN STAFF_MEMBERS sm ON pa.ATTENDING_DOCTOR = sm.STAFF_ID
LEFT JOIN DEPARTMENTS d ON sm.DEPARTMENT_ID = d.DEPARTMENT_ID
LEFT JOIN (
    SELECT PATIENT_ID, ADMISSION_ID, RECORDED_DATE, TEMPERATURE, 
           BLOOD_PRESSURE_SYSTOLIC, BLOOD_PRESSURE_DIASTOLIC, HEART_RATE,
           ROW_NUMBER() OVER (PARTITION BY PATIENT_ID, ADMISSION_ID ORDER BY RECORDED_DATE DESC) as rn
    FROM VITAL_SIGNS
) vs ON pa.PATIENT_ID = vs.PATIENT_ID AND pa.ADMISSION_ID = vs.ADMISSION_ID AND vs.rn = 1
LEFT JOIN LAB_ORDERS lo ON pa.PATIENT_ID = lo.PATIENT_ID AND pa.ADMISSION_ID = lo.ADMISSION_ID 
                          AND lo.ORDER_STATUS IN ('ORDERED', 'COLLECTED', 'PROCESSING')
LEFT JOIN PRESCRIPTIONS pr ON pa.PATIENT_ID = pr.PATIENT_ID AND pa.ADMISSION_ID = pr.ADMISSION_ID 
                             AND pr.PRESCRIPTION_STATUS = 'PRESCRIBED'
WHERE pa.STATUS = 'ADMITTED'
GROUP BY pa.ADMISSION_ID, pa.HOSPITAL_ID, h.HOSPITAL_NAME, pa.PATIENT_ID, p.PATIENT_NUMBER,
         p.FIRST_NAME, p.LAST_NAME, pa.ADMISSION_DATE, pa.ADMISSION_TYPE, pa.CHIEF_COMPLAINT,
         pa.PRELIMINARY_DIAGNOSIS, pa.ROOM_NUMBER, pa.BED_NUMBER, sm.FIRST_NAME, sm.LAST_NAME,
         sm.SPECIALIZATION, d.DEPARTMENT_NAME, vs.RECORDED_DATE, vs.TEMPERATURE,
         vs.BLOOD_PRESSURE_SYSTOLIC, vs.BLOOD_PRESSURE_DIASTOLIC, vs.HEART_RATE;

-- Staff workload view
CREATE OR REPLACE VIEW V_STAFF_WORKLOAD AS
SELECT 
    sm.STAFF_ID,
    sm.HOSPITAL_ID,
    h.HOSPITAL_NAME,
    sm.EMPLOYEE_NUMBER,
    sm.FIRST_NAME || ' ' || sm.LAST_NAME AS STAFF_NAME,
    sm.STAFF_TYPE,
    sm.SPECIALIZATION,
    d.DEPARTMENT_NAME,
    COUNT(DISTINCT pa.PATIENT_ID) AS CURRENT_PATIENTS,
    COUNT(DISTINCT lo.ORDER_ID) AS PENDING_LAB_ORDERS,
    COUNT(DISTINCT pr.PRESCRIPTION_ID) AS ACTIVE_PRESCRIPTIONS,
    COUNT(DISTINCT pp.PATIENT_PROCEDURE_ID) AS SCHEDULED_PROCEDURES,
    ss.SCHEDULE_DATE AS NEXT_SCHEDULE_DATE,
    ss.START_TIME || '-' || ss.END_TIME AS NEXT_SHIFT_TIME
FROM STAFF_MEMBERS sm
INNER JOIN HOSPITALS h ON sm.HOSPITAL_ID = h.HOSPITAL_ID
INNER JOIN DEPARTMENTS d ON sm.DEPARTMENT_ID = d.DEPARTMENT_ID
LEFT JOIN PATIENT_ADMISSIONS pa ON sm.STAFF_ID = pa.ATTENDING_DOCTOR AND pa.STATUS = 'ADMITTED'
LEFT JOIN LAB_ORDERS lo ON sm.STAFF_ID = lo.DOCTOR_ID AND lo.ORDER_STATUS IN ('ORDERED', 'COLLECTED', 'PROCESSING')
LEFT JOIN PRESCRIPTIONS pr ON sm.STAFF_ID = pr.DOCTOR_ID AND pr.PRESCRIPTION_STATUS = 'PRESCRIBED'
LEFT JOIN PATIENT_PROCEDURES pp ON sm.STAFF_ID = pp.PRIMARY_SURGEON AND pp.PROCEDURE_STATUS = 'SCHEDULED'
LEFT JOIN (
    SELECT STAFF_ID, SCHEDULE_DATE, START_TIME, END_TIME,
           ROW_NUMBER() OVER (PARTITION BY STAFF_ID ORDER BY SCHEDULE_DATE ASC) as rn
    FROM STAFF_SCHEDULES
    WHERE SCHEDULE_DATE >= TRUNC(SYSDATE) AND STATUS = 'SCHEDULED'
) ss ON sm.STAFF_ID = ss.STAFF_ID AND ss.rn = 1
WHERE sm.EMPLOYMENT_STATUS = 'ACTIVE'
GROUP BY sm.STAFF_ID, sm.HOSPITAL_ID, h.HOSPITAL_NAME, sm.EMPLOYEE_NUMBER, sm.FIRST_NAME,
         sm.LAST_NAME, sm.STAFF_TYPE, sm.SPECIALIZATION, d.DEPARTMENT_NAME,
         ss.SCHEDULE_DATE, ss.START_TIME, ss.END_TIME;

-- Financial summary view
CREATE OR REPLACE VIEW V_FINANCIAL_SUMMARY AS
SELECT 
    b.HOSPITAL_ID,
    h.HOSPITAL_NAME,
    TO_CHAR(b.BILL_DATE, 'YYYY-MM') AS BILLING_MONTH,
    COUNT(b.BILL_ID) AS TOTAL_BILLS,
    SUM(b.TOTAL_AMOUNT) AS TOTAL_BILLED,
    SUM(b.INSURANCE_AMOUNT) AS TOTAL_INSURANCE,
    SUM(b.PATIENT_AMOUNT) AS TOTAL_PATIENT,
    SUM(CASE WHEN b.BILLING_STATUS = 'PAID' THEN b.TOTAL_AMOUNT ELSE 0 END) AS TOTAL_COLLECTED,
    SUM(CASE WHEN b.BILLING_STATUS IN ('PENDING', 'OVERDUE') THEN b.TOTAL_AMOUNT ELSE 0 END) AS TOTAL_OUTSTANDING,
    COUNT(CASE WHEN b.BILLING_STATUS = 'OVERDUE' THEN 1 END) AS OVERDUE_BILLS
FROM BILLING b
INNER JOIN HOSPITALS h ON b.HOSPITAL_ID = h.HOSPITAL_ID
WHERE b.BILL_DATE >= ADD_MONTHS(TRUNC(SYSDATE, 'MM'), -12)
GROUP BY b.HOSPITAL_ID, h.HOSPITAL_NAME, TO_CHAR(b.BILL_DATE, 'YYYY-MM');

-- AI/ML insights view
CREATE OR REPLACE VIEW V_AI_INSIGHTS AS
SELECT 
    ai.HOSPITAL_ID,
    h.HOSPITAL_NAME,
    ai.PATIENT_ID,
    p.PATIENT_NUMBER,
    p.FIRST_NAME || ' ' || p.LAST_NAME AS PATIENT_NAME,
    ai.CLASSIFICATION_TYPE,
    ai.MODEL_NAME,
    ai.CLASSIFICATION_RESULT,
    ai.CONFIDENCE_SCORE,
    ai.RISK_LEVEL,
    ai.CLASSIFICATION_DATE,
    ai.VALIDATION_STATUS,
    ap.PREDICTION_TYPE,
    ap.RISK_PROBABILITY,
    ap.PREDICTED_LOS_DAYS,
    ap.READMISSION_RISK,
    CASE 
        WHEN ai.CONFIDENCE_SCORE >= 0.9 THEN 'HIGH_CONFIDENCE'
        WHEN ai.CONFIDENCE_SCORE >= 0.7 THEN 'MEDIUM_CONFIDENCE'
        ELSE 'LOW_CONFIDENCE'
    END AS CONFIDENCE_CATEGORY
FROM AI_CLASSIFICATIONS ai
INNER JOIN HOSPITALS h ON ai.HOSPITAL_ID = h.HOSPITAL_ID
INNER JOIN PATIENTS p ON ai.PATIENT_ID = p.PATIENT_ID
LEFT JOIN AI_PREDICTIONS ap ON ai.PATIENT_ID = ap.PATIENT_ID 
                              AND ai.HOSPITAL_ID = ap.HOSPITAL_ID
WHERE ai.CLASSIFICATION_STATUS = 'COMPLETED'
  AND ai.CLASSIFICATION_DATE >= SYSDATE - 30;

-- ===================================================================
-- 15. UTILITY FUNCTIONS AND PACKAGES
-- ===================================================================

-- Function to calculate patient age
CREATE OR REPLACE FUNCTION GET_PATIENT_AGE(
    p_date_of_birth IN DATE,
    p_as_of_date IN DATE DEFAULT SYSDATE
) RETURN NUMBER IS
BEGIN
    RETURN FLOOR(MONTHS_BETWEEN(p_as_of_date, p_date_of_birth) / 12);
END;
/

-- Function to get next available bed
CREATE OR REPLACE FUNCTION GET_NEXT_AVAILABLE_BED(
    p_hospital_id IN NUMBER,
    p_room_type IN VARCHAR2 DEFAULT NULL
) RETURN NUMBER IS
    v_bed_id NUMBER;
BEGIN
    SELECT b.BED_ID
    INTO v_bed_id
    FROM BEDS b
    INNER JOIN ROOMS r ON b.ROOM_ID = r.ROOM_ID
    WHERE b.HOSPITAL_ID = p_hospital_id
      AND b.BED_STATUS = 'AVAILABLE'
      AND (p_room_type IS NULL OR r.ROOM_TYPE = p_room_type)
      AND ROWNUM = 1
    ORDER BY r.ROOM_NUMBER, b.BED_NUMBER;
    
    RETURN v_bed_id;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RETURN NULL;
END;
/

-- Package for patient management operations
CREATE OR REPLACE PACKAGE PKG_PATIENT_MANAGEMENT IS
    -- Admit patient
    PROCEDURE ADMIT_PATIENT(
        p_patient_id IN NUMBER,
        p_hospital_id IN NUMBER,
        p_attending_doctor IN NUMBER,
        p_admission_type IN VARCHAR2,
        p_chief_complaint IN VARCHAR2,
        p_room_type IN VARCHAR2 DEFAULT 'GENERAL',
        p_admission_id OUT NUMBER
    );
    
    -- Discharge patient
    PROCEDURE DISCHARGE_PATIENT(
        p_admission_id IN NUMBER,
        p_discharge_disposition IN VARCHAR2,
        p_final_diagnosis IN VARCHAR2,
        p_discharge_date IN DATE DEFAULT SYSDATE
    );
    
    -- Transfer patient to different room/department
    PROCEDURE TRANSFER_PATIENT(
        p_admission_id IN NUMBER,
        p_new_room_id IN NUMBER,
        p_new_bed_id IN NUMBER DEFAULT NULL,
        p_transfer_reason IN VARCHAR2 DEFAULT NULL
    );
    
END PKG_PATIENT_MANAGEMENT;
/

CREATE OR REPLACE PACKAGE BODY PKG_PATIENT_MANAGEMENT IS

    PROCEDURE ADMIT_PATIENT(
        p_patient_id IN NUMBER,
        p_hospital_id IN NUMBER,
        p_attending_doctor IN NUMBER,
        p_admission_type IN VARCHAR2,
        p_chief_complaint IN VARCHAR2,
        p_room_type IN VARCHAR2 DEFAULT 'GENERAL',
        p_admission_id OUT NUMBER
    ) IS
        v_bed_id NUMBER;
        v_room_number VARCHAR2(20);
        v_bed_number VARCHAR2(20);
    BEGIN
        -- Get available bed
        v_bed_id := GET_NEXT_AVAILABLE_BED(p_hospital_id, p_room_type);
        
        IF v_bed_id IS NULL THEN
            RAISE_APPLICATION_ERROR(-20001, 'No available beds for room type: ' || p_room_type);
        END IF;
        
        -- Get room and bed details
        SELECT r.ROOM_NUMBER, b.BED_NUMBER
        INTO v_room_number, v_bed_number
        FROM BEDS b
        INNER JOIN ROOMS r ON b.ROOM_ID = r.ROOM_ID
        WHERE b.BED_ID = v_bed_id;
        
        -- Create admission record
        INSERT INTO PATIENT_ADMISSIONS (
            PATIENT_ID, HOSPITAL_ID, ATTENDING_DOCTOR, ADMISSION_DATE,
            ADMISSION_TYPE, CHIEF_COMPLAINT, ROOM_NUMBER, BED_NUMBER, STATUS
        ) VALUES (
            p_patient_id, p_hospital_id, p_attending_doctor, SYSDATE,
            p_admission_type, p_chief_complaint, v_room_number, v_bed_number, 'ADMITTED'
        ) RETURNING ADMISSION_ID INTO p_admission_id;
        
        -- Update bed status
        UPDATE BEDS 
        SET BED_STATUS = 'OCCUPIED',
            CURRENT_PATIENT_ID = p_patient_id,
            OCCUPIED_SINCE = SYSDATE
        WHERE BED_ID = v_bed_id;
        
        COMMIT;
    END ADMIT_PATIENT;
    
    PROCEDURE DISCHARGE_PATIENT(
        p_admission_id IN NUMBER,
        p_discharge_disposition IN VARCHAR2,
        p_final_diagnosis IN VARCHAR2,
        p_discharge_date IN DATE DEFAULT SYSDATE
    ) IS
        v_patient_id NUMBER;
        v_hospital_id NUMBER;
        v_bed_number VARCHAR2(20);
    BEGIN
        -- Get patient and bed information
        SELECT pa.PATIENT_ID, pa.HOSPITAL_ID, pa.BED_NUMBER
        INTO v_patient_id, v_hospital_id, v_bed_number
        FROM PATIENT_ADMISSIONS pa
        WHERE pa.ADMISSION_ID = p_admission_id
          AND pa.STATUS = 'ADMITTED';
        
        -- Update admission record
        UPDATE PATIENT_ADMISSIONS
        SET DISCHARGE_DATE = p_discharge_date,
            FINAL_DIAGNOSIS = p_final_diagnosis,
            DISCHARGE_DISPOSITION = p_discharge_disposition,
            STATUS = 'DISCHARGED'
        WHERE ADMISSION_ID = p_admission_id;
        
        -- Update bed status
        UPDATE BEDS
        SET BED_STATUS = 'AVAILABLE',
            CURRENT_PATIENT_ID = NULL,
            OCCUPIED_SINCE = NULL
        WHERE HOSPITAL_ID = v_hospital_id
          AND BED_NUMBER = v_bed_number;
          
        COMMIT;
    END DISCHARGE_PATIENT;
    
    PROCEDURE TRANSFER_PATIENT(
        p_admission_id IN NUMBER,
        p_new_room_id IN NUMBER,
        p_new_bed_id IN NUMBER DEFAULT NULL,
        p_transfer_reason IN VARCHAR2 DEFAULT NULL
    ) IS
        v_patient_id NUMBER;
        v_hospital_id NUMBER;
        v_old_bed_number VARCHAR2(20);
        v_new_room_number VARCHAR2(20);
        v_new_bed_number VARCHAR2(20);
        v_target_bed_id NUMBER;
    BEGIN
        -- Get current admission details
        SELECT pa.PATIENT_ID, pa.HOSPITAL_ID, pa.BED_NUMBER
        INTO v_patient_id, v_hospital_id, v_old_bed_number
        FROM PATIENT_ADMISSIONS pa
        WHERE pa.ADMISSION_ID = p_admission_id
          AND pa.STATUS = 'ADMITTED';
        
        -- Determine target bed
        v_target_bed_id := COALESCE(p_new_bed_id, GET_NEXT_AVAILABLE_BED(v_hospital_id));
        
        IF v_target_bed_id IS NULL THEN
            RAISE_APPLICATION_ERROR(-20002, 'No available beds for transfer');
        END IF;
        
        -- Get new room and bed details
        SELECT r.ROOM_NUMBER, b.BED_NUMBER
        INTO v_new_room_number, v_new_bed_number
        FROM BEDS b
        INNER JOIN ROOMS r ON b.ROOM_ID = r.ROOM_ID
        WHERE b.BED_ID = v_target_bed_id;
        
        -- Update old bed
        UPDATE BEDS
        SET BED_STATUS = 'AVAILABLE',
            CURRENT_PATIENT_ID = NULL,
            OCCUPIED_SINCE = NULL
        WHERE HOSPITAL_ID = v_hospital_id
          AND BED_NUMBER = v_old_bed_number;
        
        -- Update new bed
        UPDATE BEDS
        SET BED_STATUS = 'OCCUPIED',
            CURRENT_PATIENT_ID = v_patient_id,
            OCCUPIED_SINCE = SYSDATE
        WHERE BED_ID = v_target_bed_id;
        
        -- Update admission record
        UPDATE PATIENT_ADMISSIONS
        SET ROOM_NUMBER = v_new_room_number,
            BED_NUMBER = v_new_bed_number
        WHERE ADMISSION_ID = p_admission_id;
        
        -- Log transfer in medical records
        INSERT INTO MEDICAL_RECORDS (
            PATIENT_ID, ADMISSION_ID, HOSPITAL_ID, DOCTOR_ID, VISIT_DATE,
            VISIT_TYPE, ASSESSMENT_AND_PLAN
        ) VALUES (
            v_patient_id, p_admission_id, v_hospital_id, 
            (SELECT ATTENDING_DOCTOR FROM PATIENT_ADMISSIONS WHERE ADMISSION_ID = p_admission_id),
            SYSDATE, 'TRANSFER',
            'Patient transferred from ' || v_old_bed_number || ' to ' || v_new_bed_number ||
            CASE WHEN p_transfer_reason IS NOT NULL THEN '. Reason: ' || p_transfer_reason ELSE '' END
        );
        
        COMMIT;
    END TRANSFER_PATIENT;
    
END PKG_PATIENT_MANAGEMENT;
/

-- ===================================================================
-- 16. INDEXES FOR PERFORMANCE OPTIMIZATION
-- ===================================================================

-- Composite indexes for common query patterns
CREATE INDEX IDX_PATIENT_ADM_STATUS_DATE ON PATIENT_ADMISSIONS(STATUS, ADMISSION_DATE);
CREATE INDEX IDX_LAB_ORDERS_STATUS_DATE ON LAB_ORDERS(ORDER_STATUS, ORDER_DATE);
CREATE INDEX IDX_PRESCRIPTIONS_STATUS_DATE ON PRESCRIPTIONS(PRESCRIPTION_STATUS, PRESCRIPTION_DATE);
CREATE INDEX IDX_MEDICAL_RECORDS_PATIENT_DATE ON MEDICAL_RECORDS(PATIENT_ID, VISIT_DATE);
CREATE INDEX IDX_VITAL_SIGNS_PATIENT_DATE ON VITAL_SIGNS(PATIENT_ID, RECORDED_DATE);
CREATE INDEX IDX_AI_CLASS_PATIENT_TYPE ON AI_CLASSIFICATIONS(PATIENT_ID, CLASSIFICATION_TYPE);
CREATE INDEX IDX_BILLING_STATUS_DATE ON BILLING(BILLING_STATUS, BILL_DATE);

-- Function-based indexes
CREATE INDEX IDX_PATIENTS_FULL_NAME ON PATIENTS(UPPER(FIRST_NAME || ' ' || LAST_NAME));
CREATE INDEX IDX_PATIENTS_AGE ON PATIENTS(FLOOR(MONTHS_BETWEEN(SYSDATE, DATE_OF_BIRTH) / 12));

-- ===================================================================
-- 17. INITIAL SYSTEM DATA
-- ===================================================================

-- Insert default hospital
INSERT INTO HOSPITALS (
    HOSPITAL_NAME, ADDRESS, CITY, STATE, COUNTRY, PHONE, EMAIL,
    LICENSE_NUMBER, ESTABLISHMENT_DATE, STATUS, HOSPITAL_TYPE, BED_CAPACITY
) VALUES (
    'General Medical Center', '123 Healthcare Blvd', 'Medical City', 'State',
    'Country', '+1-555-HOSPITAL', 'info@generalmedicaenter.com',
    'LIC-2024-001', DATE '2024-01-01', 'ACTIVE', 'GENERAL', 500
);

-- Insert default departments
INSERT INTO DEPARTMENTS (HOSPITAL_ID, DEPARTMENT_NAME, DEPARTMENT_CODE, STATUS)
SELECT 1, 'Emergency Department', 'ED', 'ACTIVE' FROM DUAL UNION ALL
SELECT 1, 'Internal Medicine', 'IM', 'ACTIVE' FROM DUAL UNION ALL
SELECT 1, 'Surgery', 'SURG', 'ACTIVE' FROM DUAL UNION ALL
SELECT 1, 'Pediatrics', 'PEDS', 'ACTIVE' FROM DUAL UNION ALL
SELECT 1, 'Cardiology', 'CARD', 'ACTIVE' FROM DUAL UNION ALL
SELECT 1, 'Radiology', 'RAD', 'ACTIVE' FROM DUAL UNION ALL
SELECT 1, 'Laboratory', 'LAB', 'ACTIVE' FROM DUAL UNION ALL
SELECT 1, 'Pharmacy', 'PHARM', 'ACTIVE' FROM DUAL;

-- Insert sample room types and rooms
INSERT INTO ROOMS (HOSPITAL_ID, DEPARTMENT_ID, ROOM_NUMBER, ROOM_TYPE, BED_CAPACITY, DAILY_RATE)
SELECT 1, 1, 'ER-' || LPAD(LEVEL, 2, '0'), 'ER', 1, 200 FROM DUAL CONNECT BY LEVEL <= 10
UNION ALL
SELECT 1, 3, 'OR-' || LPAD(LEVEL, 2, '0'), 'OR', 1, 1000 FROM DUAL CONNECT BY LEVEL <= 5
UNION ALL
SELECT 1, 2, 'GEN-' || LPAD(LEVEL, 3, '0'), 'GENERAL', 2, 150 FROM DUAL CONNECT BY LEVEL <= 100;

-- Insert beds for rooms
INSERT INTO BEDS (ROOM_ID, HOSPITAL_ID, BED_NUMBER, BED_TYPE, BED_STATUS)
SELECT r.ROOM_ID, r.HOSPITAL_ID, 
       r.ROOM_NUMBER || '-' || LPAD(LEVEL, 2, '0'),
       CASE r.ROOM_TYPE 
           WHEN 'ER' THEN 'EMERGENCY'
           WHEN 'OR' THEN 'SURGICAL'
           ELSE 'STANDARD'
       END,
       'AVAILABLE'
FROM ROOMS r
CROSS JOIN (SELECT LEVEL FROM DUAL CONNECT BY LEVEL <= 2) b
WHERE r.BED_CAPACITY >= LEVEL;

-- Insert default system configurations
INSERT INTO SYSTEM_CONFIGURATIONS (HOSPITAL_ID, CONFIG_CATEGORY, CONFIG_KEY, CONFIG_VALUE, DESCRIPTION)
SELECT 1, 'GENERAL', 'HOSPITAL_TIMEZONE', 'UTC', 'Hospital timezone setting' FROM DUAL UNION ALL
SELECT 1, 'AI_ML', 'ENABLE_AI_CLASSIFICATION', 'Y', 'Enable AI-powered classification' FROM DUAL UNION ALL
SELECT 1, 'AI_ML', 'CONFIDENCE_THRESHOLD', '0.7', 'Minimum confidence score for AI predictions' FROM DUAL UNION ALL
SELECT 1, 'BILLING', 'AUTO_GENERATE_BILLS', 'Y', 'Automatically generate bills on discharge' FROM DUAL UNION ALL
SELECT 1, 'ALERTS', 'ENABLE_CRITICAL_ALERTS', 'Y', 'Enable critical patient alerts' FROM DUAL;

COMMIT;

-- ===================================================================
-- END OF HOSPITAL MANAGEMENT SYSTEM SCHEMA
-- ===================================================================

/* 
SUMMARY:
This comprehensive Oracle database schema provides:

1. Multi-hospital support with complete data isolation
2. Patient management with allergies, insurance, and medical history
3. Staff management with schedules and workload tracking  
4. Clinical workflows including admissions, procedures, lab orders
5. AI/ML integration for classifications and predictions
6. Financial management with detailed billing
7. Facility management for rooms, beds, and equipment
8. Comprehensive audit trails and system configurations
9. Performance-optimized indexes and views
10. Business logic packages and utility functions

Key Features:
- Scalable multi-tenant architecture
- AI/ML integration ready
- Complete audit trail
- Automated triggers for business rules
- Views for common reporting needs
- Utility packages for common operations
- Performance optimized with proper indexing

The schema follows Oracle best practices and can be easily extended 
for additional healthcare modules and integrations.
*/ HOSPITALS_PATIENT_SEQ
START WITH 1
INCREMENT BY 1
NOCACHE
NOCYCLE;

CREATE SEQUENCE